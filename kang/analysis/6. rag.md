## RAG

### 6.1 Data Loaders and Splitters

ğŸ“œ [ê³µì‹ë¬¸ì„œ-Retrival](https://python.langchain.com/v0.1/docs/modules/data_connection/)

ğŸ“ **UnstructureFileLoader**

- ë‹¤ì–‘í•œ íŒŒì¼ë“¤ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ
- pdf, docx, excel, html ... even ppt!

ğŸ“Œ **loaderì˜ output**

```python
print(loader.load())
print(len(loader.load()))
```

```
[Document(page_content='~~~~~')]
1
```

- Document ê°ì²´ì˜ Listì¸ë° í•˜ë‚˜ë¡œ ëª¨ë‘ í¬í•¨ë˜ì–´ ìˆìŒ
  â˜ textë¥¼ ë‚˜ëˆ„ì–´ì¤˜ì•¼ í•  í•„ìš”ê°€ ìˆìŒ

ğŸ‘€ **chunk**

- chunk: ë¬¸ì„œê°€ ë‚˜ëˆ„ì–´ì§„ ë‹¨ìœ„
- chunk_size: ê¸€ì ìˆ˜
  - chunk_sizeë¥¼ ì¸¡ì •í•˜ëŠ” ê¸°ë³¸ì ì¸ ë°©ë²•ì€ pythonì˜ len function

ğŸ“ **RecursiveCharacterTextSplitter**

- ë¬¸ì¥ ëì´ë‚˜ ë¬¸ë‹¨ì˜ ëë¶€ë¶„ë§ˆë‹¤ ëŠì–´ì¤Œ
- ë¬¸ì¥ ì¤‘ê°„ì—ì„œ ì§¤ë ¤ ì˜ë¯¸ë¥¼ ìƒì–´ë²„ë¦¬ëŠ” ê²ƒì„ ë°©ì§€
- _parameters_
  - chunk_size: ë¬¸ë‹¨ì˜ ì‚¬ì´ì¦ˆ
  - chunk_overlap: ì• ì¡°ê°ì˜ ëì„ ì¡°ê¸ˆ ê°€ì ¸ì™€ ë¬¸ì¥ì„ ì—°ê²°ì‹œí‚´

ğŸ“ **CharacterTextSplitter**

- _parameters_
  - chunk_size, chunk_overlap
  - splitter: ë¬¸ë‹¨ì„ splite

â›”ï¸ **CharacterTextSplitterëŠ” ë‚´ ìƒê°ê³¼ ë‹¤ë¥´ê²Œ ë¶„í• í•œë‹¤!**

ğŸ“œ [Stackoverflow CharacterTextSplitter](https://stackoverflow.com/questions/76633836/what-does-langchain-charactertextsplitters-chunk-size-param-even-do)

- CharacterTextSplitterëŠ” êµ¬ë¶„ ê¸°í˜¸(ê¸°ë³¸ê°’ì€ '\n\n')ì—ì„œë§Œ ë¶„í• ë¨
- chunk_sizeëŠ” ë¶„í• ì´ ê°€ëŠ¥í•œ ê²½ìš° ë¶„í• í•  ìµœëŒ€ ì²­í¬ í¬ê¸°
- ë¬¸ìì—´ì´ nê°œì˜ ë¬¸ìë¡œ ì‹œì‘í•˜ê³ , êµ¬ë¶„ ê¸°í˜¸ê°€ ìˆìœ¼ë©°, ë‹¤ìŒ êµ¬ë¶„ ê¸°í˜¸ ì•ì— mê°œì˜ ë¬¸ìê°€ ë” ìˆëŠ” ê²½ìš° ì²« ë²ˆì§¸ ì²­í¬ í¬ê¸°ëŠ” chunk_size < n + m + len(separator)ì´ë©´ nì´ ë¨

ğŸŒˆ **Example**

**Case1**

```python
from langchain.text_splitter import CharacterTextSplitter

# "\n\n"ë¥¼ êµ¬ë¶„ìë¡œ ì„¤ì •í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ë¶„í• 
splitter = CharacterTextSplitter(
    separator=r"\n\n",
    is_separator_regex=True,
    chunk_size=12,
    chunk_overlap=0,
)

# ì˜ˆì œ í…ìŠ¤íŠ¸ ì„¤ì •
text = """Part 1, Chapter 1\n\nPart One\n\n1\n\nIt was a bright cold day in April, and the clocks were striking thirteen. Winston Smith, his chin nuzzled into his"""

# í…ìŠ¤íŠ¸ ë¶„í•  ìˆ˜í–‰
split_texts = splitter.split_text(text)

# ë¶„í• ëœ ì²­í¬ì˜ ìˆ˜ ì¶œë ¥
print(len(split_texts))

# ë¶„í• ëœ ì²­í¬ ì¶œë ¥
for i, chunk in enumerate(split_texts):
    print(f"Chunk {i + 1}:\n{chunk}\n")
```

```
Created a chunk of size 17, which is longer than the specified 12
4
Chunk 1:
Part 1, Chapter 1

Chunk 2:
Part One

Chunk 3:
1

Chunk 4:
It was a bright cold day in April, and the clocks were striking thirteen. Winston Smith, his chin nuzzled into his
```

- chunk_size (12) < n+m+len(sep) (13) â˜ True
  - n: 8 (Part One)
  - m: 1 (1)
  - len(sep): 4
- chunk_sizeê°€ nê¹Œì§€

**Case2**

```python
splitter = CharacterTextSplitter(
    separator=r"\n\n",
    is_separator_regex=True,
    chunk_size=13,
    chunk_overlap=0,
)

# í…ìŠ¤íŠ¸ ë¶„í•  ìˆ˜í–‰
split_texts = splitter.split_text(text)

# ë¶„í• ëœ ì²­í¬ì˜ ìˆ˜ ì¶œë ¥
print(len(split_texts))

# ë¶„í• ëœ ì²­í¬ ì¶œë ¥
for i, chunk in enumerate(split_texts):
    print(f"Chunk {i + 1}:\n{chunk}\n")
```

```
Created a chunk of size 17, which is longer than the specified 13
3
Chunk 1:
Part 1, Chapter 1

Chunk 2:
Part One\n\n1

Chunk 3:
It was a bright cold day in April, and the clocks were striking thirteen. Winston Smith, his chin nuzzled into his
```

- chunk_size (13) < n+m+len(sep) (13) â˜ false
  - n: 8 (Part One)
  - m: 1 (1)
  - len(sep): 4
- chunk_sizeê°€ nì´ ì•„ë‹ˆë¼ ë‹¤ìŒ ë¶„í•  ê¹Œì§€ í¬í•¨ (êµ¬ë¶„ìë„ í¬í•¨ë¨)

### 6.2 Tiktoken

ğŸ–¥ï¸ [OpenAI Tokenizer](https://platform.openai.com/tokenizer)

ğŸ“ **tiktoken**

> Text splitter that uses tiktoken encoder to count length. made by openAI

- OpenAIì˜ í† í¬ë‚˜ì´ì €ë¡œ ë¶„í• í•˜ê¸°ì— ëª¨ë¸ê³¼ lanchain ë‚´ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¹´ìš´íŒ…í•˜ëŠ” ë°©ë²•ì´ ì¼ì¹˜í•˜ê²Œ ë¨

### 6.3 Vectors

ğŸ–¥ï¸ [Word to Vec](https://turbomaze.github.io/word2vecjson/)

### 6.4 Vector Store

ğŸ“Œ **embed_queryì˜ ê³¼ì •**

- Step1. í† í°í™” â˜ tiktoken
- Step2. ì„ë² ë”© â˜ model api
- Step3. ì§‘ê³„ â˜ ë²¡í„° í‰ê· ì˜ ì •ê·œí™”

ğŸ“ **vectorstore**

> ë²¡í„° ê³µê°„ì—ì„œ ê²€ìƒ‰ì„ í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ë°ì´í„° ë² ì´ìŠ¤

ğŸ“ **LocalFileStore**

> BaseStore interface that works on the local file system.

ğŸ“ **CacheBackedEmbeddings**

> Interface for caching results from embedding models.

- from_bytes_store: ìºì‹œì— ì„ë² ë”©ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ 
  - ì—†ë‹¤ë©´ openai embedding
  - ìˆë‹¤ë©´ cached embedding (vector store)

### 6.5 Langsmith

ğŸ‘€ **Langsmith**

> api ì‚¬ìš© ë¶„ì„

```
LANGCHAIN_TRACING_V2=true
LANGCHAIN_ENDPOINT='https://api.smith.langchain.com'
LANGCHAIN_API_KEY='API_KEY'
```

### 6.6 RetrievalQA

ğŸ“ **RetrievalQA**

> Chain for question-answering against an index

- LLM chainê³¼ ê°™ì€ legacyí•œ chain
- ë‚´ë¶€ì— chainì´ êµ¬í˜„ë˜ì–´ ìˆìŒ
- _parameters_
  - llm: model
  - chain_type: QA chain type â˜ ì¶”í›„ì„¤ëª…
  - retriver
    - retrieverëŠ” interface
    - êµ¬ì¡°í™” ë˜ì§€ ì•Šì€ query(ìì—°ì–´ ì§ˆì˜)ë¥¼ í•´ì„í•˜ì—¬ documentë¥¼ ë°˜í™˜
    - vector storeê°™ì€ ì €ì¥ ê¸°ëŠ¥ì´ í•„ìš”í•˜ì§€ ì•Šìœ¼ë©° ë‹¨ì§€ ë°˜í™˜í•˜ëŠ” ì—­í• ë§Œ í•˜ë©´ ë¨
    - vectorstore â˜ retriever

ğŸ“ **RetrievalQA chain_type**

**1. Stuff**

> ëª¨ë“  documentë¥¼ promptì— ì±„ì›Œ(stuff) ë„£ëŠ” ê²ƒ

- ğŸ“œ [ê³µì‹ë¬¸ì„œ Stuff](https://js.langchain.com/v0.1/docs/modules/chains/document/stuff/)

**2. Refine**

> ë¬¸ì„œë¥¼ í•˜ë‚˜ì”© ì§ˆë¬¸í•˜ì—¬ ì–»ì€ ë‹µì„ ë‹¤ì‹œ ì§ˆë¬¸ìœ¼ë¡œ ë„£ëŠ” ê³¼ì •ì„ ë°˜ë³µí•˜ë©° ì§ˆë¬¸ì„ ê°œì„ (refine) ì‹œí‚´

- ğŸ“œ [ê³µì‹ë¬¸ì„œ Refine](https://js.langchain.com/v0.1/docs/modules/chains/document/refine/)

**3. MapReduce**

> ë¬¸ì„œ í•˜ë‚˜í•˜ë‚˜ë¥¼ ìš”ì•½í•˜ì—¬ ìµœì¢… í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•˜ê³  ì´ë¥¼ ìµœì¢… ì§ˆë¬¸ìœ¼ë¡œ ì „ë‹¬

- ğŸ“œ [ê³µì‹ë¬¸ì„œ MapReduce](https://js.langchain.com/v0.1/docs/modules/chains/document/map_reduce/)

### 6.8 Stuff LCEL Chain

- LCELì˜ prompt ë¶€ë¶„ì— ëª¨ë“  ë¬¸ì„œë¥¼ ì „ë‹¬ â˜ stuff

ğŸ“Œ **Retriver LCEL**

- first chain: retrieverëŠ” document listë¥¼ ë°˜í™˜í•˜ê³  ì´ëŠ” String
- middle cahin: Stringì€ propmt templateìœ¼ë¡œ ì¸í•´ propmt valueë¥¼ ê°€ì§
- last cahin: promptë¡œ llm ìˆ˜í–‰
